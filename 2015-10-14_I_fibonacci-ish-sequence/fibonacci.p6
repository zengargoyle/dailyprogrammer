
use v6;

sub fib-for-all(Int $target) {
  # get over the special cases
  return 0, if $target == 0;
  return 0, 1 if $target == 1;

  # potentially infinite list of fibonacci numbers
  my @fib = 0,1,*+*...*;

  # gather all below or equal to target value
  my @seq = gather for @fib -> $f { last if $f > $target; $f.take; }

  # factor is target / last fib that evenly divides into it
  my $F = $target div @seq.grep($target %% *).[*-1];
  
  # multiply by factor, drop the extras
  return @seq.map(* * $F).grep(* <= $target);
}

sub MAIN( 'test' ) {
  use Test;

  is fib-for-all(0), (0,), 'test 0';
  is fib-for-all(1), (0,1), 'test 1';
  is fib-for-all(21), (0,1,1,2,3,5,8,13,21), 'test 21';
  is fib-for-all(84), (0,4,4,8,12,20,32,52,84), 'test 84';
  is fib-for-all(578), (0,17,17,34,51,85,136,221,357,578), 'test 578';
  is fib-for-all(123456789), (0,41152263,41152263,82304526,123456789), 'test 123456789';
  is fib-for-all(38695577906193299), (0,7,7,14,21,35,56,91,147,238,385,623,1008,1631,2639,4270,6909,11179,18088,29267,47355,76622,123977,200599,324576,525175,849751,1374926,2224677,3599603,5824280,9423883,15248163,24672046,39920209,64592255,104512464,169104719,273617183,442721902,716339085,1159060987,1875400072,3034461059,4909861131,7944322190,12854183321,20798505511,33652688832,54451194343,88103883175,142555077518,230658960693,373214038211,603872998904,977087037115,1580960036019,2558047073134,4139007109153,6697054182287,10836061291440,17533115473727,28369176765167,45902292238894,74271469004061,120173761242955,194445230247016,314618991489971,509064221736987,823683213226958,1332747434963945,2156430648190903,3489178083154848,5645608731345751,9134786814500599,14780395545846350,23915182360346949,38695577906193299), 'test 38695577906193299';

  done-testing();
}
